name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_frontend:
        description: 'Skip frontend build'
        required: false
        default: false
        type: boolean
      skip_backend:
        description: 'Skip backend build'
        required: false
        default: false
        type: boolean

# Prevents parallel deployments
concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  DEPLOY_PATH: /var/www/orbitask-manager

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Pull latest changes
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
            export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            cd "\$DEPLOY_PATH"
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin main
            # Check for local changes and stash them if needed (preserving untracked files)
            if ! git diff-index --quiet HEAD --; then
              echo "âš ï¸  Local changes detected, stashing..."
              git stash push -m "Auto-stash before deployment $(date +%Y-%m-%d_%H:%M:%S)"
            fi
            # Attempt fast-forward merge, fallback to merge if needed
            if ! git merge --ff-only origin/main; then
              echo "âš ï¸  Fast-forward not possible, attempting merge..."
              git merge origin/main --no-edit || {
                echo "âŒ Merge failed, aborting..."
                git merge --abort
                exit 1
              }
            fi
            echo "âœ… Successfully updated to latest main"
          EOF

      - name: Build Frontend
        if: ${{ github.event.inputs.skip_frontend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
            export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            cd "\$DEPLOY_PATH/frontend"
            echo "ðŸ“¦ Installing frontend dependencies..."
            pnpm install --frozen-lockfile
            echo "ðŸ”¨ Building frontend..."
            pnpm run build
          EOF

      - name: Build Backend
        if: ${{ github.event.inputs.skip_backend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
            export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            cd "\$DEPLOY_PATH/backend"
            echo "ðŸ“¦ Installing backend dependencies..."
            pnpm install --frozen-lockfile
            echo "ðŸ”¨ Building backend..."
            pnpm run build
          EOF

      - name: Reload PM2 Application
        if: ${{ github.event.inputs.skip_backend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "ðŸ”„ Reloading PM2 process..."
            pm2 reload orbitask --update-env
            echo "âœ… PM2 status:"
            pm2 show orbitask
            echo "ðŸ¥ Running health check..."
            sleep 5
            if pm2 show orbitask | grep -q "online"; then
              echo "âœ… Application is running"
            else
              echo "âŒ Application failed to start"
              pm2 logs orbitask --lines 50
              exit 1
            fi
          EOF

      - name: Cleanup SSH
        if: always()
        run: rm -rf ~/.ssh/deploy_key

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Git Pull | Done |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_frontend }}" != "true" ]; then
            echo "| Frontend Build | Done |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Frontend Build | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.skip_backend }}" != "true" ]; then
            echo "| Backend Build | Done |" >> $GITHUB_STEP_SUMMARY
            echo "| PM2 Reload | Done |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend Build | Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "| PM2 Reload | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

