name: Test & Deploy to VPS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: false
        type: boolean
      skip_frontend:
        description: 'Skip frontend build'
        required: false
        default: false
        type: boolean
      skip_backend:
        description: 'Skip backend build'
        required: false
        default: false
        type: boolean

# Prevents parallel deployments
concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  DEPLOY_PATH: /var/www/orbitask-manager

jobs:
  # ============================================
  # TEST JOB - Runs on GitHub Runner
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Skip tests only on manual trigger with skip_tests=true
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: pnpm install --no-frozen-lockfile

      - name: Run Frontend Tests
        working-directory: frontend
        run: pnpm run test:run

      - name: Install Backend Dependencies
        working-directory: backend
        run: pnpm install --frozen-lockfile

      - name: Run Backend Tests
        working-directory: backend
        run: pnpm run test

  # ============================================
  # DEPLOY JOB - Runs after tests pass
  # ============================================
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    # Only deploy on push to main or manual trigger (not on PRs)
    # Run if: tests passed OR tests were skipped (manual trigger with skip_tests)
    if: |
      github.event_name != 'pull_request' && 
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    needs: [test]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "${{ secrets.SSH_HOST_KEY }}" >> ~/.ssh/known_hosts

      - name: Pull latest changes
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
            export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            cd "\$DEPLOY_PATH"
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin main
            # Check for local changes and stash them if needed (preserving untracked files)
            if ! git diff-index --quiet HEAD --; then
              echo "âš ï¸  Local changes detected, stashing..."
              git stash push -m "Auto-stash before deployment $(date +%Y-%m-%d_%H:%M:%S)"
            fi
            # Attempt fast-forward merge, fallback to merge if needed
            if ! git merge --ff-only origin/main; then
              echo "âš ï¸  Fast-forward not possible, attempting merge..."
              git merge origin/main --no-edit || {
                echo "âŒ Merge failed, aborting..."
                git merge --abort
                exit 1
              }
            fi
            echo "âœ… Successfully updated to latest main"
          EOF

      - name: Build Frontend
        if: ${{ github.event.inputs.skip_frontend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
            export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            cd "\$DEPLOY_PATH/frontend"
            echo "ðŸ“¦ Installing frontend dependencies..."
            pnpm install --frozen-lockfile
            echo "ðŸ”¨ Building frontend..."
            pnpm run build
          EOF

      - name: Build Backend
        if: ${{ github.event.inputs.skip_backend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
            export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            cd "\$DEPLOY_PATH/backend"
            echo "ðŸ“¦ Installing backend dependencies..."
            pnpm install --frozen-lockfile
            echo "ðŸ”¨ Building backend..."
            pnpm run build
          EOF

      - name: Reload PM2 Application
        if: ${{ github.event.inputs.skip_backend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "ðŸ”„ Reloading PM2 process..."
            pm2 reload orbitask --update-env
            echo "âœ… PM2 status:"
            pm2 show orbitask
            echo "ðŸ¥ Running health check..."
            sleep 5
            if pm2 show orbitask | grep -q "online"; then
              echo "âœ… Application is running"
            else
              echo "âŒ Application failed to start"
              pm2 logs orbitask --lines 50
              exit 1
            fi
          EOF

      - name: Cleanup SSH
        if: always()
        run: rm -rf ~/.ssh/deploy_key

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Git Pull | Done |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_frontend }}" != "true" ]; then
            echo "| Frontend Build | Done |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Frontend Build | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.skip_backend }}" != "true" ]; then
            echo "| Backend Build | Done |" >> $GITHUB_STEP_SUMMARY
            echo "| PM2 Reload | Done |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend Build | Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "| PM2 Reload | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

